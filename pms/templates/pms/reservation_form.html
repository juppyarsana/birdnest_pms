{% extends "base.html" %}
{% load currency_filters %}
{% block title %}{% if editing %}Edit Reservation{% else %}New Reservation{% endif %}{% endblock %}
{% block extra_css %}
<!-- jQuery (required for Select2) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Select2 CSS for searchable dropdowns -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
    /* Custom Select2 styling */
    .select2-container--default .select2-selection--single {
        border: 2px solid #e9ecef !important;
        border-radius: 10px !important;
        height: 48px !important;
        padding: 0.75rem 1rem !important;
        background: white !important;
        transition: all 0.3s ease !important;
    }
    
    .select2-container--default .select2-selection--single:focus,
    .select2-container--default.select2-container--focus .select2-selection--single {
        border-color: #667eea !important;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25) !important;
        transform: translateY(-2px) !important;
    }
    
    .select2-container--default .select2-selection--single .select2-selection__rendered {
        line-height: 32px !important;
        padding-left: 0 !important;
        color: #495057 !important;
        font-weight: 500 !important;
    }
    
    .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 46px !important;
        right: 10px !important;
    }
    
    .select2-dropdown {
        border: 2px solid #667eea !important;
        border-radius: 10px !important;
        box-shadow: 0 10px 30px rgba(0,0,0,0.15) !important;
    }
    
    .select2-container--default .select2-results__option--highlighted[aria-selected] {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        color: white !important;
    }
    
    .select2-search--dropdown .select2-search__field {
        border: 2px solid #e9ecef !important;
        border-radius: 8px !important;
        padding: 0.5rem !important;
        margin: 0.5rem !important;
        width: calc(100% - 1rem) !important;
    }
    
    .select2-search--dropdown .select2-search__field:focus {
        border-color: #667eea !important;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25) !important;
    }
    
    .select2-results__option {
        padding: 0.75rem 1rem !important;
        font-weight: 500 !important;
    }
    
    .select2-container {
        width: 100% !important;
    }
    
    /* Custom Guest Search Styling */
    .guest-search-container {
        position: relative;
    }
    
    .guest-search-input {
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 0.75rem 1rem;
        transition: all 0.3s ease;
        background: white;
    }
    
    .guest-search-input:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        transform: translateY(-2px);
    }
    
    .guest-search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 2px solid #e9ecef;
        border-top: none;
        border-radius: 0 0 10px 10px;
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    
    .guest-search-results.show {
        display: block;
    }
    
    .guest-result-item {
        padding: 0.75rem 1rem;
        cursor: pointer;
        border-bottom: 1px solid #f8f9fa;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .guest-result-item:hover {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .guest-result-item.selected {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .guest-result-item:last-child {
        border-bottom: none;
        border-radius: 0 0 8px 8px;
    }
    
    .guest-result-name {
        font-weight: 600;
        font-size: 1rem;
    }
    
    .guest-result-details {
        font-size: 0.875rem;
        opacity: 0.8;
    }
    
    .guest-search-no-results {
        padding: 1rem;
        text-align: center;
        color: #6c757d;
        font-style: italic;
    }
    
    .guest-search-loading {
        padding: 1rem;
        text-align: center;
        color: #667eea;
    }
    
    .guest-search-input.has-selection {
        background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%);
        border-color: #28a745;
    }
    
    .page-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
        border-radius: 15px;
        position: relative;
        overflow: hidden;
    }
    
    .page-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, rgba(255,255,255,0.1) 25%, transparent 25%, transparent 75%, rgba(255,255,255,0.1) 75%), 
                    linear-gradient(45deg, rgba(255,255,255,0.1) 25%, transparent 25%, transparent 75%, rgba(255,255,255,0.1) 75%);
        background-size: 20px 20px;
        background-position: 0 0, 10px 10px;
        animation: shimmer 20s linear infinite;
    }
    
    @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }
    
    .form-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        border: none;
        overflow: hidden;
        transition: all 0.3s ease;
    }
    
    .form-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 40px rgba(0,0,0,0.15);
    }
    
    .form-section {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border-left: 4px solid #667eea;
    }
    
    .form-section h5 {
        color: #495057;
        font-weight: 600;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .form-control, .form-select {
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 0.75rem 1rem;
        transition: all 0.3s ease;
        background: white;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        transform: translateY(-2px);
    }
    
    .form-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 0.5rem;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 25px;
        padding: 0.75rem 2rem;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }
    
    .btn-secondary {
        border-radius: 25px;
        padding: 0.75rem 2rem;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-outline-success {
        border-radius: 25px;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        transition: all 0.3s ease;
        border: 2px solid #28a745;
    }
    
    .btn-outline-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(40, 167, 69, 0.3);
    }
    
    .fade-in {
        animation: fadeIn 0.6s ease-in;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .icon-accent {
        color: #667eea;
        font-size: 1.2em;
    }
    
    /* Guest Type Button Styling */
    .btn-check:checked + .btn-outline-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        border-color: #667eea !important;
        color: white !important;
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
    }
    
    .btn-outline-primary {
        border: 2px solid #667eea;
        color: #667eea;
        font-weight: 600;
        transition: all 0.3s ease;
        border-radius: 10px;
        padding: 0.75rem 1.5rem;
    }
    
    .btn-outline-primary:hover {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-color: #667eea;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
    }
    
    .btn-group .btn-outline-primary:first-child {
        border-top-right-radius: 0;
        border-bottom-right-radius: 0;
    }
    
    .btn-group .btn-outline-primary:last-child {
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
        border-left: none;
    }
    
    .btn-group .btn-outline-primary:not(:first-child):not(:last-child) {
        border-radius: 0;
        border-left: none;
    }
</style>
{% endblock %}
{% block content %}
<div class="container py-4">
    <!-- Page Header -->
    <div class="page-header fade-in">
        <div class="container position-relative">
            <div>
                <h1 class="mb-2">
                    <i class="bi {% if editing %}bi-pencil-square{% else %}bi-plus-circle{% endif %} me-2"></i>
                    {% if editing %}Edit Reservation{% else %}Create New Reservation{% endif %}
                </h1>
                <p class="mb-0 opacity-75">
                    {% if editing %}
                        Update reservation details and manage booking information
                    {% else %}
                        Create a new reservation for your guests
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
    
    <!-- Reservation Form -->
    <div class="form-card fade-in">
        <div class="card-body p-4">
            <form method="post">
                {% csrf_token %}
                
                <!-- Step 1: Dates Selection -->
                <div class="form-section">
                    <h5><i class="bi bi-calendar-check icon-accent"></i>Step 1: Select Dates</h5>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="check_in_date" class="form-label">Check-in Date *</label>
                            <input type="date" 
                                   id="check_in_date" 
                                   name="check_in" 
                                   class="form-control" 
                                   required>
                            {% if form.check_in.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.check_in.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            <label for="nights_select" class="form-label">Number of Nights *</label>
                            <select id="nights_select" name="nights_select" class="form-select" required>
                                <option value="">Select nights</option>
                                <option value="1">1 Night</option>
                                <option value="2">2 Nights</option>
                                <option value="3">3 Nights</option>
                                <option value="4">4 Nights</option>
                                <option value="5">5 Nights</option>
                                <option value="6">6 Nights</option>
                                <option value="7">7 Nights</option>
                                <option value="14">14 Nights</option>
                                <option value="30">30 Nights</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="check_out_date" class="form-label">Check-out Date</label>
                            <input type="date" 
                                   id="check_out_date" 
                                   name="check_out" 
                                   class="form-control" 
                                   readonly>
                            {% if form.check_out.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.check_out.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Step 2: Room Selection -->
                <div class="form-section" id="room-selection-section" style="display: none;">
                    <h5><i class="bi bi-door-open icon-accent"></i>Step 2: Select Room</h5>
                    <div id="room-loading" class="text-center py-4" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading available rooms...</span>
                        </div>
                        <p class="mt-2 text-muted">Checking room availability...</p>
                    </div>
                    <div id="room-options" class="row g-3">
                        <!-- Available rooms will be populated here -->
                    </div>
                    {% if form.room.errors %}
                        <div class="text-danger small mt-1">
                            {% for error in form.room.errors %}
                                <div>{{ error }}</div>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                
                <!-- Step 3: Guest Information -->
                <div class="form-section" id="guest-info-section" style="display: none;">
                    <h5><i class="bi bi-person icon-accent"></i>Step 3: Guest Information</h5>
                    
                    <!-- Guest Selection Toggle -->
                    <div class="row g-3 mb-3">
                        <div class="col-12">
                            <div class="btn-group w-100" role="group" aria-label="Guest selection type">
                                <input type="radio" class="btn-check" name="guest-type" id="new-guest" value="new" autocomplete="off" checked>
                                <label class="btn btn-outline-primary" for="new-guest">
                                    <i class="bi bi-person-plus me-2"></i>Add New Guest
                                </label>
                                
                                <input type="radio" class="btn-check" name="guest-type" id="existing-guest" value="existing" autocomplete="off">
                                <label class="btn btn-outline-primary" for="existing-guest">
                                    <i class="bi bi-search me-2"></i>Select Existing Guest
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Existing Guest Selection -->
                    <div id="existing-guest-section" class="guest-section" style="display: none;">
                        <div class="row g-3">
                            <div class="col-12">
                                <label for="guest-search" class="form-label">Search Existing Guest</label>
                                <div class="guest-search-container">
                                    <input type="text" 
                                           id="guest-search" 
                                           class="form-control guest-search-input" 
                                           placeholder="Search by name, email, or phone..." 
                                           autocomplete="off">
                                    <div id="guest-search-results" class="guest-search-results"></div>
                                </div>
                            </div>
                            <div class="col-12" id="selected-guest-info" style="display: none;">
                                <div class="alert alert-success">
                                    <h6 class="mb-2"><i class="bi bi-check-circle me-2"></i>Selected Guest:</h6>
                                    <div id="selected-guest-details"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- New Guest Information -->
                    <div id="new-guest-section" class="guest-section">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="guest_name" class="form-label">Guest Name *</label>
                                <input type="text" 
                                       id="guest_name" 
                                       name="guest_name" 
                                       class="form-control" 
                                       placeholder="Enter guest full name" 
                                       required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Contact Information * <small class="text-muted">(Email OR Phone required)</small></label>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <input type="email" 
                                               id="guest_email" 
                                               name="guest_email" 
                                               class="form-control contact-field" 
                                               placeholder="Email address">
                                    </div>
                                    <div class="col-6">
                                        <input type="tel" 
                                               id="guest_phone" 
                                               name="guest_phone" 
                                               class="form-control contact-field" 
                                               placeholder="Phone number">
                                    </div>
                                </div>
                                <div id="contact-error" class="text-danger small mt-1" style="display: none;">
                                    Please provide either email or phone number.
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row g-3 mt-2">
                        <div class="col-md-4">
                            <label for="{{ form.agent.id_for_label }}" class="form-label">Agent/Source</label>
                            {{ form.agent }}
                            {% if form.agent.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.agent.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    <input type="hidden" name="guest" id="selected-guest-id" value="{{ form.guest.value|default:'' }}">
                    <input type="hidden" name="room" id="selected-room-id" value="{{ form.room.value|default:'' }}">
                    
                    <!-- Nights selection for auto-calculation -->
                    <input type="hidden" name="nights" id="nights_hidden" value="1">
                </div>
                
                {% if editing %}
                <!-- Status & Payment Section (Only for editing) -->
                <div class="form-section">
                    <h5><i class="bi bi-credit-card icon-accent"></i>Status & Payment</h5>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="{{ form.status.id_for_label }}" class="form-label">Status</label>
                            {{ form.status }}
                            {% if form.status.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.status.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            <label for="{{ form.payment_method.id_for_label }}" class="form-label">Payment Method</label>
                                    {{ form.payment_method }}
                                    {% if form.payment_method.errors %}
                                        <div class="text-danger small mt-1">
                                            {% for error in form.payment_method.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            <label for="{{ form.payment_notes.id_for_label }}" class="form-label">Payment Notes</label>
                            {{ form.payment_notes }}
                            {% if form.payment_notes.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.payment_notes.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Form Errors -->
                {% if form.non_field_errors %}
                    <div class="alert alert-danger" role="alert">
                        {% for error in form.non_field_errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
                
                <!-- Action Buttons -->
                <div class="d-flex justify-content-end gap-3 mt-4">
                    <a href="{% url 'reservations_list' %}" class="btn btn-secondary">
                        <i class="bi bi-arrow-left me-2"></i>Cancel
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi {% if editing %}bi-check-circle{% else %}bi-plus-circle{% endif %} me-2"></i>
                        {% if editing %}Update Reservation{% else %}Create Reservation{% endif %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Select2 JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
// Simple checkout date calculation function
function calculateCheckout() {
    const checkInInput = document.getElementById('check_in_date');
    const nightsSelect = document.getElementById('nights_select');
    const checkOutInput = document.getElementById('check_out_date');
    const nightsHidden = document.getElementById('nights_hidden');
    const roomSection = document.getElementById('room-selection-section');
    const guestSection = document.getElementById('guest-info-section');
    
    if (!checkInInput || !nightsSelect || !checkOutInput || !nightsHidden) {
        return;
    }
    
    const checkInDate = checkInInput.value;
    const nights = parseInt(nightsSelect.value);
    
    // Reset if invalid input
    if (!checkInDate || !nights || isNaN(nights) || nights <= 0) {
        checkOutInput.value = '';
        nightsHidden.value = '';
        if (roomSection) roomSection.style.display = 'none';
        if (guestSection) guestSection.style.display = 'none';
        return;
    }
    
    // Calculate checkout date
    const checkIn = new Date(checkInDate);
    const checkOut = new Date(checkIn);
    checkOut.setDate(checkIn.getDate() + nights);
    
    // Format date as YYYY-MM-DD
    const year = checkOut.getFullYear();
    const month = String(checkOut.getMonth() + 1).padStart(2, '0');
    const day = String(checkOut.getDate()).padStart(2, '0');
    const checkOutDateString = `${year}-${month}-${day}`;
    
    // Update form fields
    checkOutInput.value = checkOutDateString;
    nightsHidden.value = nights;
    
    // Show sections
    if (roomSection) {
        roomSection.style.display = 'block';
    }
    if (guestSection) {
        guestSection.style.display = 'block';
    }
    
    // Load available rooms
    if (typeof loadAvailableRooms === 'function') {
        loadAvailableRooms(checkInDate, checkOutDateString);
    }
}

// Function to load available rooms
function loadAvailableRooms(checkIn, checkOut) {
    const roomLoading = document.getElementById('room-loading');
    const roomOptions = document.getElementById('room-options');
    
    if (roomLoading) roomLoading.style.display = 'block';
    if (roomOptions) roomOptions.innerHTML = '';
    
    // Fetch available rooms
    fetch(`/api/check-available-rooms/?check_in=${checkIn}&check_out=${checkOut}`)
        .then(response => response.json())
        .then(data => {
            roomLoading.style.display = 'none';
            
            if (data.available_rooms && data.available_rooms.length > 0) {
                let html = '';
                data.available_rooms.forEach(room => {
                    html += `
                        <div class="col-md-4">
                            <div class="room-option card h-100" data-room-id="${room.id}" style="cursor: pointer; transition: all 0.3s ease;">
                                <div class="card-body">
                                    <h6 class="card-title">${room.room_number}</h6>
                                    <p class="card-text">
                                        <small class="text-muted">${room.room_type}</small><br>
                                        <strong id="room-price-${room.id}">Rp ${Math.floor(room.price_per_night).toLocaleString('id-ID')}/night</strong>
                                    </p>
                                </div>
                            </div>
                        </div>
                    `;
                });
                roomOptions.innerHTML = html;
                
                // Add click handlers for room selection
                document.querySelectorAll('.room-option').forEach(option => {
                    option.addEventListener('click', function() {
                        // Remove previous selection
                        document.querySelectorAll('.room-option').forEach(opt => {
                            opt.style.borderColor = '';
                            opt.style.backgroundColor = '';
                        });
                        
                        // Highlight selected room
                        this.style.borderColor = '#667eea';
                        this.style.backgroundColor = '#f8f9ff';
                        
                        // Set hidden input
                        document.getElementById('selected-room-id').value = this.dataset.roomId;
                        
                        // Show guest information section
                        document.getElementById('guest-info-section').style.display = 'block';
                    });
                });
            } else {
                roomOptions.innerHTML = '<div class="col-12"><div class="alert alert-warning">No rooms available for the selected dates. Please choose different dates.</div></div>';
            }
        })
        .catch(error => {
            console.error('Error loading rooms:', error);
            roomLoading.style.display = 'none';
            roomOptions.innerHTML = '<div class="col-12"><div class="alert alert-danger">Error loading rooms. Please try again.</div></div>';
        });
}

// Set minimum date on page load
document.addEventListener('DOMContentLoaded', function() {
    const checkInInput = document.getElementById('check_in_date');
    const nightsSelect = document.getElementById('nights_select');
    
    if (checkInInput) {
        const today = new Date().toISOString().split('T')[0];
        checkInInput.min = today;
        
        // Add event listeners for checkout calculation
        checkInInput.addEventListener('change', calculateCheckout);
        checkInInput.addEventListener('input', calculateCheckout);
    }
    
    if (nightsSelect) {
        nightsSelect.addEventListener('change', calculateCheckout);
    }
    
    // Initialize guest type toggle
    initializeGuestTypeToggle();
    
    // Initialize other components
    try {
        if (typeof loadGuestData === 'function') loadGuestData();
        if (typeof initializeGuestSearch === 'function') initializeGuestSearch();
        initializeContactValidation();
    } catch (error) {
        console.error('Error during initialization:', error);
    }
});

// Guest type toggle functionality
function initializeGuestTypeToggle() {
    const existingGuestRadio = document.getElementById('existing-guest');
    const newGuestRadio = document.getElementById('new-guest');
    const existingGuestSection = document.getElementById('existing-guest-section');
    const newGuestSection = document.getElementById('new-guest-section');
    
    function toggleGuestSections() {
        if (existingGuestRadio.checked) {
            existingGuestSection.style.display = 'block';
            newGuestSection.style.display = 'none';
            // Clear new guest form and remove required attribute
            clearNewGuestForm();
            // Remove required attribute from new guest fields when hidden
            document.getElementById('guest_name').removeAttribute('required');
        } else {
            existingGuestSection.style.display = 'none';
            newGuestSection.style.display = 'block';
            // Clear existing guest selection and add required attribute back
            clearExistingGuestSelection();
            // Add required attribute back to new guest fields when visible
            document.getElementById('guest_name').setAttribute('required', 'required');
        }
    }
    
    existingGuestRadio.addEventListener('change', toggleGuestSections);
    newGuestRadio.addEventListener('change', toggleGuestSections);
    
    // Set initial state based on which radio is checked
    toggleGuestSections();
}

function clearNewGuestForm() {
    document.getElementById('guest_name').value = '';
    document.getElementById('guest_email').value = '';
    document.getElementById('guest_phone').value = '';
}

function clearExistingGuestSelection() {
    const searchInput = document.getElementById('guest-search');
    const selectedGuestInfo = document.getElementById('selected-guest-info');
    
    searchInput.value = '';
    searchInput.classList.remove('has-selection');
    selectedGuestInfo.style.display = 'none';
    document.getElementById('selected-guest-id').value = '';
    hideResults();
}

// Contact validation function
function initializeContactValidation() {
    const contactFields = document.querySelectorAll('.contact-field');
    
    function validateContact() {
    // Check which guest type is selected
    const existingGuestRadio = document.getElementById('existing-guest');
    const newGuestRadio = document.getElementById('new-guest');
    
    // If existing guest is selected, check if a guest is actually selected
    if (existingGuestRadio && existingGuestRadio.checked) {
        const selectedGuestId = document.getElementById('selected-guest-id')?.value;
        if (!selectedGuestId) {
            // Show error for existing guest selection
            const errorDiv = document.getElementById('contact-error');
            if (errorDiv) {
                errorDiv.textContent = 'Please select an existing guest.';
                errorDiv.style.display = 'block';
            }
            return false;
        } else {
            // Hide error if guest is selected
            const errorDiv = document.getElementById('contact-error');
            if (errorDiv) errorDiv.style.display = 'none';
            return true;
        }
    }
    
    // If new guest is selected, validate name, email/phone
    if (newGuestRadio && newGuestRadio.checked) {
        const name = document.getElementById('guest_name')?.value.trim() || '';
        const email = document.getElementById('guest_email')?.value.trim() || '';
        const phone = document.getElementById('guest_phone')?.value.trim() || '';
        const errorDiv = document.getElementById('contact-error');
        
        // Validate name is required for new guests
        if (!name) {
            if (errorDiv) {
                errorDiv.textContent = 'Guest name is required.';
                errorDiv.style.display = 'block';
            }
            // Focus on the name field
            document.getElementById('guest_name').focus();
            return false;
        }
        
        // Validate email or phone is provided
        if (!email && !phone) {
            if (errorDiv) {
                errorDiv.textContent = 'Please provide either email or phone number.';
                errorDiv.style.display = 'block';
            }
            return false;
        } else {
            if (errorDiv) errorDiv.style.display = 'none';
            return true;
        }
    }
    
    return true; // Default to true if neither radio is checked
}
    
    contactFields.forEach(field => {
        field.addEventListener('blur', validateContact);
        field.addEventListener('input', validateContact);
    });
    
    // Form submission validation
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            const newGuestRadio = document.getElementById('new-guest');
            const existingGuestRadio = document.getElementById('existing-guest');
            
            // Check which guest type is selected
            if (newGuestRadio && newGuestRadio.checked) {
                // Handle new guest creation
                const guestName = document.getElementById('guest_name').value.trim();
                const guestEmail = document.getElementById('guest_email').value.trim();
                const guestPhone = document.getElementById('guest_phone').value.trim();
                
                if (!guestName) {
                    e.preventDefault();
                    alert('Please enter a guest name.');
                    document.getElementById('guest_name').focus();
                    return;
                }
                
                if (!guestEmail && !guestPhone) {
                    e.preventDefault();
                    alert('Please enter either an email or phone number for the guest.');
                    document.getElementById('guest_email').focus();
                    return;
                }
                
                // Prevent form submission and create guest first
                e.preventDefault();
                
                // Create or find guest, then submit form
                createOrFindGuestAndSubmit(guestName, guestEmail, guestPhone, form);
                
            } else if (existingGuestRadio && existingGuestRadio.checked) {
                // Handle existing guest selection
                const selectedGuestId = document.getElementById('selected-guest-id').value;
                if (!selectedGuestId) {
                    e.preventDefault();
                    alert('Please select a guest.');
                    document.getElementById('guest-search').focus();
                    return;
                }
            }
            
            // Additional contact validation for new guests
            if (newGuestRadio && newGuestRadio.checked && !validateContact()) {
                e.preventDefault();
                const emailField = document.getElementById('guest_email');
                if (emailField) emailField.focus();
            }
        });
    }
}
</script>

{% if not editing %}
<!-- Add Guest Modal -->
<div class="modal fade" id="addGuestModal" tabindex="-1" aria-labelledby="addGuestModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content" style="border-radius: 15px; border: none; box-shadow: 0 20px 40px rgba(0,0,0,0.15);">
      <div class="modal-header" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border-radius: 15px 15px 0 0;">
        <h5 class="modal-title" id="addGuestModalLabel">
          <i class="bi bi-person-plus me-2"></i>Add New Guest
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="addGuestForm" method="post" action="{% url 'guests' %}">
        {% csrf_token %}
        <div class="modal-body p-4">
          <div class="row g-3">
            <div class="col-md-6">
              <label for="guestName" class="form-label fw-bold">Name *</label>
              <input type="text" class="form-control" id="guestName" name="name" required style="border-radius: 10px; border: 2px solid #e9ecef;">
            </div>
            <div class="col-md-6">
              <label for="guestEmail" class="form-label fw-bold">Email</label>
              <input type="email" class="form-control" id="guestEmail" name="email" style="border-radius: 10px; border: 2px solid #e9ecef;">
            </div>
            <div class="col-md-6">
              <label for="guestPhone" class="form-label fw-bold">Phone</label>
              <input type="text" class="form-control" id="guestPhone" name="phone" style="border-radius: 10px; border: 2px solid #e9ecef;">
            </div>
            <div class="col-md-6">
              <label for="guestDOB" class="form-label fw-bold">Date of Birth</label>
              <input type="date" class="form-control" id="guestDOB" name="date_of_birth" style="border-radius: 10px; border: 2px solid #e9ecef;">
            </div>
            <div class="col-md-6">
              <label for="guestIdType" class="form-label fw-bold">ID Type</label>
              <input type="text" class="form-control" id="guestIdType" name="id_type" placeholder="e.g., Passport, KTP" style="border-radius: 10px; border: 2px solid #e9ecef;">
            </div>
            <div class="col-md-6">
              <label for="guestIdNumber" class="form-label fw-bold">ID Number</label>
              <input type="text" class="form-control" id="guestIdNumber" name="id_number" style="border-radius: 10px; border: 2px solid #e9ecef;">
            </div>
            <div class="col-12">
              <label for="guestAddress" class="form-label fw-bold">Address</label>
              <textarea class="form-control" id="guestAddress" name="address" rows="2" style="border-radius: 10px; border: 2px solid #e9ecef;"></textarea>
            </div>
            <div class="col-md-6">
              <label for="guestEmergencyContactName" class="form-label fw-bold">Emergency Contact Name</label>
              <input type="text" class="form-control" id="guestEmergencyContactName" name="emergency_contact_name" style="border-radius: 10px; border: 2px solid #e9ecef;">
            </div>
            <div class="col-md-6">
              <label for="guestEmergencyContactPhone" class="form-label fw-bold">Emergency Contact Phone</label>
              <input type="text" class="form-control" id="guestEmergencyContactPhone" name="emergency_contact_phone" style="border-radius: 10px; border: 2px solid #e9ecef;">
            </div>
          </div>
        </div>
        <div class="modal-footer" style="border-top: 1px solid #e9ecef; padding: 1.5rem;">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius: 25px; padding: 0.75rem 1.5rem; font-weight: 600;">
            <i class="bi bi-x-circle me-2"></i>Cancel
          </button>
          <button type="submit" class="btn btn-success" style="border-radius: 25px; padding: 0.75rem 1.5rem; font-weight: 600; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border: none;">
            <i class="bi bi-person-plus me-2"></i>Add Guest
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>

function createOrFindGuestAndSubmit(name, email, phone, form) {
    // First, try to find existing guest
    const existingGuest = guestData.find(guest => 
        guest.name.toLowerCase() === name.toLowerCase() || 
        (email && guest.email === email) ||
        (phone && guest.phone === phone)
    );
    
    if (existingGuest) {
        document.getElementById('selected-guest-id').value = existingGuest.id;
        form.submit();
    } else {
        // Create new guest via AJAX
        const formData = new FormData();
        formData.append('name', name);
        if (email) formData.append('email', email);
        if (phone) formData.append('phone', phone);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        fetch('/guests/', {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.guest_id) {
                document.getElementById('selected-guest-id').value = data.guest_id;
                form.submit();
            } else {
                alert('Error creating guest: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error creating guest:', error);
            alert('Error creating guest. Please try again.');
        });
    }
}

function createOrFindGuest(name, email, phone) {
    // First, try to find existing guest
    const existingGuest = guestData.find(guest => 
        guest.name.toLowerCase() === name.toLowerCase() || 
        (email && guest.email === email) ||
        (phone && guest.phone === phone)
    );
    
    if (existingGuest) {
        document.getElementById('selected-guest-id').value = existingGuest.id;
    } else {
        // Create new guest via AJAX
        const formData = new FormData();
        formData.append('name', name);
        if (email) formData.append('email', email);
        if (phone) formData.append('phone', phone);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        fetch('/guests/', {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.guest_id) {
                document.getElementById('selected-guest-id').value = data.guest_id;
            }
        })
        .catch(error => {
            console.error('Error creating guest:', error);
        });
    }
}

let guestData = [];
let selectedGuestIndex = -1;
let currentSearchTerm = '';

// Fetch guest data on page load
function initializeGuestSearch() {
    loadGuestData();
    initializeGuestSearchHandlers();
}

function initializeGuestSearchHandlers() {
    const searchInput = document.getElementById('guest-search');
    const resultsContainer = document.getElementById('guest-search-results');
    
    if (!searchInput || !resultsContainer) {
        console.log('Guest search elements not found');
        return;
    }
    
    console.log('Initializing guest search handlers');
    
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.trim();
        currentSearchTerm = searchTerm;
        
        if (searchTerm.length === 0) {
            hideResults();
            return;
        }
        
        if (searchTerm.length >= 1) {
            performSearch(searchTerm);
        }
    });
    
    // Keyboard navigation
    searchInput.addEventListener('keydown', function(e) {
        const results = document.querySelectorAll('.guest-result-item');
        
        switch(e.key) {
            case 'ArrowDown':
                e.preventDefault();
                selectedGuestIndex = Math.min(selectedGuestIndex + 1, results.length - 1);
                updateSelection();
                break;
            case 'ArrowUp':
                e.preventDefault();
                selectedGuestIndex = Math.max(selectedGuestIndex - 1, -1);
                updateSelection();
                break;
            case 'Enter':
                e.preventDefault();
                if (selectedGuestIndex >= 0 && results.length > 0) {
                    const guestData = JSON.parse(results[selectedGuestIndex].dataset.guest);
                    selectGuest(guestData);
                }
                break;
            case 'Escape':
                hideResults();
                break;
        }
    });
    
    // Click outside to hide results
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.guest-search-container')) {
            hideResults();
        }
    });
    
    // Focus event
    searchInput.addEventListener('focus', function() {
        if (currentSearchTerm.length >= 1) {
            performSearch(currentSearchTerm);
        }
    });
}

function loadGuestData() {
    fetch('/guests/json/')
        .then(resp => resp.json())
        .then(data => {
            // Handle both direct array and object with guests property
            guestData = data.guests || data;
            console.log('Loaded guest data:', guestData);
            
            // Set initial guest if editing
            const selectedGuestId = document.getElementById('selected-guest-id').value;
            if (selectedGuestId) {
                const selectedGuest = guestData.find(g => g.id == selectedGuestId);
                if (selectedGuest) {
                    const searchInput = document.getElementById('guest-search');
                    searchInput.value = selectedGuest.name;
                    searchInput.classList.add('has-selection');
                }
            }
        })
        .catch(error => {
            console.error('Failed to load guest data:', error);
        });
}

function performSearch(searchTerm) {
    console.log('Performing search for:', searchTerm);
    console.log('Guest data available:', guestData.length, 'guests');
    const results = fuzzySearch(guestData, searchTerm);
    console.log('Search results:', results.length, 'matches');
    displayResults(results);
}

function fuzzySearch(data, searchTerm) {
    const term = searchTerm.toLowerCase();
    
    return data.filter(guest => {
        const name = guest.name.toLowerCase();
        const email = (guest.email || '').toLowerCase();
        const phone = (guest.phone || '').toLowerCase();
        
        // Exact match gets highest priority
        if (name.includes(term)) return true;
        if (email.includes(term)) return true;
        if (phone.includes(term)) return true;
        
        // Fuzzy matching - check if all characters of search term exist in order
        let nameIndex = 0;
        for (let i = 0; i < term.length; i++) {
            nameIndex = name.indexOf(term[i], nameIndex);
            if (nameIndex === -1) return false;
            nameIndex++;
        }
        return true;
    }).sort((a, b) => {
        // Sort by relevance
        const aName = a.name.toLowerCase();
        const bName = b.name.toLowerCase();
        const aStartsWith = aName.startsWith(term);
        const bStartsWith = bName.startsWith(term);
        
        if (aStartsWith && !bStartsWith) return -1;
        if (!aStartsWith && bStartsWith) return 1;
        
        return aName.localeCompare(bName);
    });
}

function displayResults(results) {
    const resultsContainer = document.getElementById('guest-search-results');
    console.log('Displaying results, container found:', !!resultsContainer);
    
    if (results.length === 0) {
        resultsContainer.innerHTML = '<div class="guest-search-no-results">No guests found. Try a different search term.</div>';
    } else {
        let html = '';
        results.forEach((guest, index) => {
            const email = guest.email ? ` • ${guest.email}` : '';
            const phone = guest.phone ? ` • ${guest.phone}` : '';
            html += `
                <div class="guest-result-item" data-guest='${JSON.stringify(guest)}' data-index="${index}">
                    <div>
                        <div class="guest-result-name">${highlightMatch(guest.name, currentSearchTerm)}</div>
                        <div class="guest-result-details">${email}${phone}</div>
                    </div>
                </div>
            `;
        });
        resultsContainer.innerHTML = html;
        console.log('Results HTML set, length:', html.length);
        
        // Add click handlers
        document.querySelectorAll('.guest-result-item').forEach(item => {
            item.addEventListener('click', function() {
                const guest = JSON.parse(this.dataset.guest);
                selectGuest(guest);
            });
        });
    }
    
    resultsContainer.classList.add('show');
    console.log('Results container classes:', resultsContainer.className);
    selectedGuestIndex = -1;
}

function highlightMatch(text, searchTerm) {
    if (!searchTerm) return text;
    
    const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
    return text.replace(regex, '<strong>$1</strong>');
}

function updateSelection() {
    document.querySelectorAll('.guest-result-item').forEach(item => {
        item.classList.remove('selected');
    });
    if (selectedGuestIndex >= 0) {
        const items = document.querySelectorAll('.guest-result-item');
        if (items[selectedGuestIndex]) {
            items[selectedGuestIndex].classList.add('selected');
        }
    }
}

function selectGuest(guest) {
    const searchInput = document.getElementById('guest-search');
    const selectedGuestInfo = document.getElementById('selected-guest-info');
    const selectedGuestDetails = document.getElementById('selected-guest-details');
    
    // Update search input
    searchInput.value = guest.name;
    searchInput.classList.add('has-selection');
    
    // Show selected guest info
    selectedGuestDetails.innerHTML = `
        <strong>${guest.name}</strong><br>
        ${guest.email ? `Email: ${guest.email}<br>` : ''}
        ${guest.phone ? `Phone: ${guest.phone}` : ''}
    `;
    selectedGuestInfo.style.display = 'block';
    
    // Set the selected guest ID
    document.getElementById('selected-guest-id').value = guest.id;
    
    hideResults();
}

function hideResults() {
    document.getElementById('guest-search-results').classList.remove('show');
}

// Function to refresh guest dropdown (for modal integration)
window.refreshGuestDropdown = function() {
    loadGuestData();
};
    
    // Initialize other form elements
    var addGuestBtn = document.querySelector('[data-bs-target="#addGuestModal"]');
    var addGuestModalEl = document.getElementById('addGuestModal');
    var addGuestModal = null;
    if (addGuestBtn && addGuestModalEl) {
        addGuestBtn.addEventListener('click', function() {
            addGuestModal = new bootstrap.Modal(addGuestModalEl);
            addGuestModal.show();
        });
    }
    var addGuestForm = document.getElementById('addGuestForm');
    if (addGuestForm) {
        addGuestForm.addEventListener('submit', function(e) {
            e.preventDefault();
            var name = document.getElementById('guestName').value.trim();
            var errors = [];
            if (!name) errors.push('Name is required.');
            if (errors.length > 0) {
                alert(errors.join('\n'));
                return;
            }
            var formData = new FormData(addGuestForm);
            fetch(addGuestForm.action, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (addGuestModal) addGuestModal.hide();
                    // Refresh guest dropdown using the new function
                    if (window.refreshGuestDropdown) {
                        window.refreshGuestDropdown();
                    }
                    
                    // Auto-select the newly created guest in Step 3
                    if (data.guest) {
                        // Switch to existing guest selection
                        const existingGuestRadio = document.getElementById('existing-guest');
                        const newGuestRadio = document.getElementById('new-guest');
                        if (existingGuestRadio && newGuestRadio) {
                            existingGuestRadio.checked = true;
                            newGuestRadio.checked = false;
                            
                            // Trigger the toggle to show existing guest section
                            const event = new Event('change');
                            existingGuestRadio.dispatchEvent(event);
                            
                            // Auto-select the new guest
                            setTimeout(function() {
                                selectGuest(data.guest);
                            }, 100);
                        }
                    }
                    
                    // Clear the form
                    addGuestForm.reset();
                    // Show success message
                    setTimeout(function() {
                        alert('Guest added successfully and selected for this reservation!');
                    }, 300);
                } else {
                    if (addGuestModal) addGuestModal.hide();
                    setTimeout(function() { alert('Failed to add guest.'); }, 300);
                }
                setTimeout(function() {
                    // Remove lingering modal-backdrop and modal-open
                    document.body.classList.remove('modal-open');
                    var backdrops = document.querySelectorAll('.modal-backdrop');
                    backdrops.forEach(function(bd) { bd.parentNode.removeChild(bd); });
                }, 400);
            })
            .catch(() => {
                if (addGuestModal) addGuestModal.hide();
                setTimeout(function() { alert('Error adding guest.'); }, 300);
                setTimeout(function() {
                    document.body.classList.remove('modal-open');
                    var backdrops = document.querySelectorAll('.modal-backdrop');
                    backdrops.forEach(function(bd) { bd.parentNode.removeChild(bd); });
                }, 400);
            });
        });
    }
</script>
{% endif %}
{% endblock %}